<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel File Validator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .upload-section {
            padding: 40px;
            text-align: center;
        }
        
        .upload-area {
            border: 3px dashed #4f46e5;
            border-radius: 15px;
            padding: 60px 20px;
            background: #f8fafc;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            background: #f1f5f9;
            border-color: #7c3aed;
        }
        
        .upload-area.dragover {
            background: #e0e7ff;
            border-color: #4f46e5;
        }
        
        .upload-icon {
            font-size: 4em;
            color: #4f46e5;
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 1.3em;
            color: #334155;
            margin-bottom: 15px;
        }
        
        .upload-subtext {
            color: #64748b;
            font-size: 0.9em;
        }
        
        #fileInput {
            display: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .results-section {
            padding: 40px;
            display: none;
        }
        
        .summary-card {
            background: #f8fafc;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border-left: 5px solid #4f46e5;
        }
        
        .summary-card.success {
            border-left-color: #10b981;
            background: #ecfdf5;
        }
        
        .summary-card.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        
        .summary-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #1e293b;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #4f46e5;
        }
        
        .stat-label {
            color: #64748b;
            margin-top: 5px;
        }
        
        .errors-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .errors-table th {
            background: #4f46e5;
            color: white;
            padding: 15px;
            text-align: left;
        }
        
        .errors-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .errors-table tr:nth-child(even) {
            background: #f8fafc;
        }
        
        .error-row {
            color: #dc2626;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .validation-rules {
            background: #f8fafc;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
        }
        
        .rules-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #1e293b;
        }
        
        .rules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .rule-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #4f46e5;
        }
        
        .rule-column {
            font-weight: bold;
            color: #4f46e5;
        }
        
        .rule-description {
            color: #64748b;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Excel File Validator</h1>
            <p>Upload your Excel file for instant validation against invoice requirements</p>
        </div>
        
        <div class="upload-section">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">📄</div>
                <div class="upload-text">Click to upload or drag & drop your Excel file</div>
                <div class="upload-subtext">Supports .xlsx, .xls files • Max 10MB</div>
                <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFile(event)">
            </div>
            <button class="btn" onclick="document.getElementById('fileInput').click()">
                Choose File
            </button>
        </div>
        
        <div class="loading">
            <div class="spinner"></div>
            <p>Validating your file...</p>
        </div>
        
        <div class="results-section" id="results">
            <!-- Results will be populated here -->
        </div>
        
        <div class="validation-rules">
            <h3 class="rules-title">📋 Validation Rules</h3>
            <div class="rules-grid">
                <div class="rule-item">
                    <div class="rule-column">Column A (UID)</div>
                    <div class="rule-description">Required field - cannot be empty</div>
                </div>
                <div class="rule-item">
                    <div class="rule-column">Column C (Invoice Type)</div>
                    <div class="rule-description">Required - must be "Normal" or "Simple"</div>
                </div>
                <div class="rule-item">
                    <div class="rule-column">Column E (Currency)</div>
                    <div class="rule-description">Required - exactly 3 characters</div>
                </div>
                <div class="rule-item">
                    <div class="rule-column">Column G (Issue Date)</div>
                    <div class="rule-description">Required - DD-MM-YYYY or yyyy-MM-ddTHH:mm:ss</div>
                </div>
                <div class="rule-item">
                    <div class="rule-column">Column M (Customer Type)</div>
                    <div class="rule-description">Required - must be "C" or "I"</div>
                </div>
                <div class="rule-item">
                    <div class="rule-column">Column O</div>
                    <div class="rule-description">Required - exactly 3 characters</div>
                </div>
                <div class="rule-item">
                    <div class="rule-column">Conditional Fields</div>
                    <div class="rule-description">When M="C": N, P, Q, R, S, T, U become required</div>
                </div>
                <div class="rule-item">
                    <div class="rule-column">Column AA, AC</div>
                    <div class="rule-description">Required - cannot be 0 or empty</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let validationData = [];
        
        // Drag and drop functionality
        const uploadArea = document.querySelector('.upload-area');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        });
        
        function handleFile(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }
        
        function processFile(file) {
            // Show loading
            document.querySelector('.loading').style.display = 'block';
            document.querySelector('.results-section').style.display = 'none';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    // Validate the data
                    validateExcelData(jsonData, file.name);
                } catch (error) {
                    alert('Error reading file: ' + error.message);
                    document.querySelector('.loading').style.display = 'none';
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function validateExcelData(data, fileName) {
            const errors = [];
            let totalRows = 0;
            
            // Skip header row, start from row 1 (index 1)
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.every(cell => !cell)) continue; // Skip empty rows
                
                totalRows++;
                const rowNum = i + 1; // Excel row number (1-based)
                
                // Validate each column
                validateRow(row, rowNum, errors);
            }
            
            // Hide loading and show results
            document.querySelector('.loading').style.display = 'none';
            displayResults(errors, totalRows, fileName);
        }
        
        function validateRow(row, rowNum, errors) {
            // Column A (UID) - Required
            if (!row[0] || String(row[0]).trim() === '') {
                errors.push({
                    row: rowNum,
                    column: 'A',
                    value: row[0] || '',
                    error: 'Required field is empty',
                    expected: 'Any non-empty value'
                });
            }
            
            // Column C (Invoice Type) - Required, must be Normal or Simple
            const colC = String(row[2] || '').trim();
            if (!colC) {
                errors.push({
                    row: rowNum,
                    column: 'C',
                    value: colC,
                    error: 'Required field is empty',
                    expected: 'Normal or Simple'
                });
            } else if (colC !== 'Normal' && colC !== 'Simple') {
                errors.push({
                    row: rowNum,
                    column: 'C',
                    value: colC,
                    error: 'Invalid value',
                    expected: 'Normal or Simple'
                });
            }
            
            // Column E (Currency) - Required, exactly 3 characters
            const colE = String(row[4] || '').trim();
            if (!colE) {
                errors.push({
                    row: rowNum,
                    column: 'E',
                    value: colE,
                    error: 'Required field is empty',
                    expected: 'Exactly 3 characters'
                });
            } else if (colE.length !== 3) {
                errors.push({
                    row: rowNum,
                    column: 'E',
                    value: colE,
                    error: 'Wrong length',
                    expected: 'Exactly 3 characters'
                });
            }
            
            // Column G (Issue Date) - Required, date format
            const colG = String(row[6] || '').trim();
            if (!colG) {
                errors.push({
                    row: rowNum,
                    column: 'G',
                    value: colG,
                    error: 'Required date field is empty',
                    expected: 'DD-MM-YYYY or yyyy-MM-ddTHH:mm:ss'
                });
            } else if (!validateDateFormat(colG)) {
                errors.push({
                    row: rowNum,
                    column: 'G',
                    value: colG,
                    error: 'Invalid date format',
                    expected: 'DD-MM-YYYY or yyyy-MM-ddTHH:mm:ss'
                });
            }
            
            // Column J - Required
            if (!row[9] || String(row[9]).trim() === '') {
                errors.push({
                    row: rowNum,
                    column: 'J',
                    value: row[9] || '',
                    error: 'Required field is empty',
                    expected: 'Any non-empty value'
                });
            }
            
            // Column M (Customer Type) - Required, must be C or I
            const colM = String(row[12] || '').trim();
            if (!colM) {
                errors.push({
                    row: rowNum,
                    column: 'M',
                    value: colM,
                    error: 'Required field is empty',
                    expected: 'C or I'
                });
            } else if (colM !== 'C' && colM !== 'I') {
                errors.push({
                    row: rowNum,
                    column: 'M',
                    value: colM,
                    error: 'Invalid value',
                    expected: 'C or I'
                });
            }
            
            // Column O - Required, exactly 3 characters
            const colO = String(row[14] || '').trim();
            if (!colO) {
                errors.push({
                    row: rowNum,
                    column: 'O',
                    value: colO,
                    error: 'Required field is empty',
                    expected: 'Exactly 3 characters'
                });
            } else if (colO.length !== 3) {
                errors.push({
                    row: rowNum,
                    column: 'O',
                    value: colO,
                    error: 'Wrong length',
                    expected: 'Exactly 3 characters'
                });
            }
            
            // Conditional validations when M = "C"
            if (colM === 'C') {
                // Column N - 15 digits starting and ending with 3
                const colN = String(row[13] || '').trim();
                if (!colN) {
                    errors.push({
                        row: rowNum,
                        column: 'N',
                        value: colN,
                        error: 'Required when M=C',
                        expected: '15 digits starting and ending with 3'
                    });
                } else if (colN.length !== 15 || !/^\d+$/.test(colN) || !colN.startsWith('3') || !colN.endsWith('3')) {
                    errors.push({
                        row: rowNum,
                        column: 'N',
                        value: colN,
                        error: 'Invalid format when M=C',
                        expected: '15 digits starting and ending with 3'
                    });
                }
                
                // Columns P, Q, R, S - Required when M=C
                ['P', 'Q', 'R', 'S'].forEach((col, idx) => {
                    const colIndex = 15 + idx; // P=15, Q=16, R=17, S=18
                    if (!row[colIndex] || String(row[colIndex]).trim() === '') {
                        errors.push({
                            row: rowNum,
                            column: col,
                            value: row[colIndex] || '',
                            error: 'Required when M=C',
                            expected: 'Any non-empty value'
                        });
                    }
                });
                
                // Column T - 5 digits when M=C
                const colT = String(row[19] || '').trim();
                if (!colT) {
                    errors.push({
                        row: rowNum,
                        column: 'T',
                        value: colT,
                        error: 'Required when M=C',
                        expected: 'Exactly 5 digits'
                    });
                } else if (colT.length !== 5 || !/^\d+$/.test(colT)) {
                    errors.push({
                        row: rowNum,
                        column: 'T',
                        value: colT,
                        error: 'Invalid format when M=C',
                        expected: 'Exactly 5 digits'
                    });
                }
                
                // Column U - 4 digits when M=C
                const colU = String(row[20] || '').trim();
                if (!colU) {
                    errors.push({
                        row: rowNum,
                        column: 'U',
                        value: colU,
                        error: 'Required when M=C',
                        expected: 'Exactly 4 digits'
                    });
                } else if (colU.length !== 4 || !/^\d+$/.test(colU)) {
                    errors.push({
                        row: rowNum,
                        column: 'U',
                        value: colU,
                        error: 'Invalid format when M=C',
                        expected: 'Exactly 4 digits'
                    });
                }
            }
            
            // Column AA (index 26) - Required, not 0
            const colAA = String(row[26] || '').trim();
            if (!colAA || colAA === '0') {
                errors.push({
                    row: rowNum,
                    column: 'AA',
                    value: colAA,
                    error: 'Required field, cannot be 0',
                    expected: 'Any non-zero value'
                });
            }
            
            // Column AC (index 28) - Required, not 0
            const colAC = String(row[28] || '').trim();
            if (!colAC || colAC === '0') {
                errors.push({
                    row: rowNum,
                    column: 'AC',
                    value: colAC,
                    error: 'Required field, cannot be 0',
                    expected: 'Any non-zero value'
                });
            }
        }
        
        function validateDateFormat(dateStr) {
            // DD-MM-YYYY format
            if (dateStr.length === 10 && dateStr.charAt(2) === '-' && dateStr.charAt(5) === '-') {
                const parts = dateStr.split('-');
                return parts.length === 3 && 
                       /^\d{2}$/.test(parts[0]) && 
                       /^\d{2}$/.test(parts[1]) && 
                       /^\d{4}$/.test(parts[2]);
            }
            
            // yyyy-MM-ddTHH:mm:ss format
            if (dateStr.length === 19 && dateStr.charAt(4) === '-' && dateStr.charAt(7) === '-' && 
                dateStr.charAt(10) === 'T' && dateStr.charAt(13) === ':' && dateStr.charAt(16) === ':') {
                return /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}$/.test(dateStr);
            }
            
            return false;
        }
        
        function displayResults(errors, totalRows, fileName) {
            const resultsSection = document.getElementById('results');
            const isValid = errors.length === 0;
            
            let html = `
                <div class="summary-card ${isValid ? 'success' : 'error'}">
                    <h2 class="summary-title">
                        ${isValid ? '✅ Validation Passed' : '❌ Validation Failed'}
                    </h2>
                    <p><strong>File:</strong> ${fileName}</p>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <div class="stat-number">${totalRows}</div>
                            <div class="stat-label">Total Rows</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" style="color: ${isValid ? '#10b981' : '#ef4444'}">${errors.length}</div>
                            <div class="stat-label">Errors Found</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" style="color: ${isValid ? '#10b981' : '#f59e0b'}">${isValid ? '100%' : Math.round(((totalRows - errors.length) / totalRows) * 100) + '%'}</div>
                            <div class="stat-label">Valid Rows</div>
                        </div>
                    </div>
                </div>
            `;
            
            if (!isValid) {
                html += `
                    <h3 style="margin-bottom: 20px; color: #dc2626;">📋 Error Details</h3>
                    <table class="errors-table">
                        <thead>
                            <tr>
                                <th>Row</th>
                                <th>Column</th>
                                <th>Current Value</th>
                                <th>Error Type</th>
                                <th>Expected Format</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                errors.forEach(error => {
                    html += `
                        <tr class="error-row">
                            <td>${error.row}</td>
                            <td><strong>${error.column}</strong></td>
                            <td>${error.value || '<empty>'}</td>
                            <td>${error.error}</td>
                            <td>${error.expected}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
            } else {
                html += `
                    <div style="text-align: center; padding: 40px; background: #ecfdf5; border-radius: 15px; margin-top: 20px;">
                        <div style="font-size: 4em; margin-bottom: 20px;">🎉</div>
                        <h3 style="color: #059669; margin-bottom: 10px;">Perfect! Your file is ready for upload</h3>
                        <p style="color: #065f46;">All validation rules passed successfully. You can safely upload this file to the system.</p>
                    </div>
                `;
            }
            
            resultsSection.innerHTML = html;
            resultsSection.style.display = 'block';
        }
    </script>
</body>
</html>